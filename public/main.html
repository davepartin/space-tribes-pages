<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Space Tribes – Command</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .card { border:1px solid #ddd; border-radius:12px; padding:1rem; }
      h2 { margin:.25rem 0 1rem; }
      button { padding:.6rem .8rem; border-radius:8px; border:1px solid #bbb; cursor:pointer; }
      .admin { background:#f8faff; border-color:#c5d3ff; }
      .hidden { display:none; }
      .row { display:flex; gap:.5rem; align-items:center; }
      pre { white-space: pre-wrap; word-break: break-word; }
      .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; border:1px solid #ddd; margin:.2rem .3rem 0 0; font-size:.9rem; }
      .badge.ok { border-color:#86d18c; background:#f4fff5; }
      .badge.no { border-color:#f0a1a1; background:#fff5f5; }
    </style>
  </head>
  <body>
    <h1>Space Tribes – Command</h1>
    <div id="subsPanel" class="card" style="margin:1rem 0;">
      <h2>Submissions Today</h2>
      <div id="subsList">Loading…</div>
    </div>
    <div class="grid">
      <div class="card">
        <h2>Status</h2>
        <div id="status">Loading…</div>
      </div>
      <div class="card">
        <h2>Submit Decisions</h2>
        <label>Decisions JSON (temporary placeholder)</label>
        <textarea id="decisions" rows="8" style="width:100%;"></textarea>
        <div class="row">
          <button id="submit">Submit Decisions</button>
          <div id="submitMsg"></div>
        </div>
      </div>
    </div>
    <div id="adminPanel" class="card admin hidden" style="margin-top:1rem;">
      <h2>Admin</h2>
      <div class="row">
        <button id="processDay">Process Day</button>
        <button id="resetGame">Reset Game</button>
        <div id="adminMsg"></div>
      </div>
    </div>
    <script>
      async function fetchStatus(){
        const res = await fetch('/game-data/me');
        const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
        if(res.ok){
          document.getElementById('status').innerHTML = '<pre>'+JSON.stringify(data,null,2)+'</pre>';

          // Render submissions strip
          const subs = data.submissionsToday || [];
          const subsHtml = subs.map(s => {
            const cls = s.submitted ? 'badge ok' : 'badge no';
            const mark = s.submitted ? '✅' : '⏳';
            return `<span class="${cls}">${mark} ${s.name}</span>`;
          }).join(' ');
          document.getElementById('subsList').innerHTML = subsHtml || 'No players yet.';

          // Update header count
          const done = subs.filter(s => s.submitted).length;
          document.querySelector('#subsPanel h2').textContent = `Submissions Today (${done}/${subs.length})`;

          // Show admin panel for Dave
          if(data.currentUser && data.currentUser.name === 'Dave'){
            document.getElementById('adminPanel').classList.remove('hidden');
          }
        }else{
          document.getElementById('status').textContent = data.error || 'Not signed in.';
          if(res.status === 401) location.href = '/';
        }
      }
      async function submitDecisions(){
        const payload = document.getElementById('decisions').value || "{}";
        const res = await fetch('/submit-decisions', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: payload
        });
        const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
        const el = document.getElementById('submitMsg');
        el.textContent = data.ok ? 'Saved!' : (data.error||'Error');
        if (data.ok) fetchStatus();
      }
      async function adminCall(path){
        const res = await fetch(path, { method:'POST' });
        const data = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
        document.getElementById('adminMsg').textContent = data.ok ? 'Done.' : (data.error||'Error');
        if(data.ok) fetchStatus();
      }
      document.getElementById('submit').onclick = submitDecisions;
      document.getElementById('processDay').onclick = ()=>adminCall('/process-day');
      document.getElementById('resetGame').onclick = ()=>adminCall('/reset-game');
      fetchStatus();
    </script>
  </body>
</html>
